# PRD: depth_snapshot配置更新适配需求

## 1. 产品概述

### 1.1 需求背景
当前配置文件`config/development.yaml`中的`data_collector.depth_snapshot`部分仍在使用旧版的滑动窗口配置，但实际的`depth_snapshot_5000`实现已经修改为单键覆盖更新机制。需要更新配置文件以适配新的实现。

### 1.2 问题分析
**现有配置问题**：
- `window_size: 60` - 保留最后60个快照（已废弃）
- `update_interval_seconds: 60` - 更新间隔（仍需要）
- `limit: 5000` - 深度限制（仍需要）

**新实现特点**：
- 使用单一Redis键：`depth_snapshot_5000`
- 新快照完全覆盖旧快照
- 无需维护滑动窗口
- 减少内存使用和提高性能

## 2. 技术规格

### 2.1 配置变更要求

#### 2.1.1 移除的配置项
```yaml
# 需要移除
window_size: 60  # 滑动窗口大小，在新实现中已废弃
```

#### 2.1.2 保留的配置项
```yaml
# 需要保留
limit: 5000  # 订单簿深度限制
update_interval_seconds: 60  # 数据更新间隔
```

#### 2.1.3 新增的配置项（可选）
```yaml
# 可选新增
enable_overwrite: true  # 明确启用覆盖模式
storage_strategy: "overwrite"  # 存储策略标识
```

### 2.2 兼容性要求

#### 2.2.1 向后兼容
- 现有代码必须能正常读取更新后的配置
- 不影响其他组件的正常运行
- 保持现有API接口不变

#### 2.2.2 配置验证
- 添加配置项验证逻辑
- 对废弃配置项给出警告提示
- 确保必要配置项存在

## 3. 实现方案

### 3.1 配置文件更新

#### 3.1.1 development.yaml更新
```yaml
data_collector:
  depth_snapshot:
    limit: 5000
    update_interval_seconds: 60
    # 移除 window_size: 60
    # 可选新增
    enable_overwrite: true
    storage_strategy: "overwrite"
```

#### 3.1.2 其他配置文件
检查是否还有其他环境配置文件需要同步更新。

### 3.2 代码适配

#### 3.2.1 配置模型更新
更新`src/utils/config.py`中的配置模型：
- 移除`window_size`字段
- 添加新的配置字段（如果需要）
- 添加配置验证逻辑

#### 3.2.2 数据收集器适配
检查`src/agents/data_collector.py`：
- 确保不再使用`window_size`配置
- 验证新配置的正确读取
- 添加配置变更的日志记录

### 3.3 测试验证

#### 3.3.1 单元测试
- 配置文件解析测试
- 配置验证逻辑测试
- 废弃配置项警告测试

#### 3.3.2 集成测试
- 数据收集器使用新配置的端到端测试
- Redis存储功能验证
- 性能对比测试

## 4. 验收标准

### 4.1 功能验收
- [x] 配置文件成功移除废弃的`window_size`配置项
- [x] 数据收集器能正确读取更新后的配置
- [x] depth_snapshot功能正常工作，使用单键覆盖机制
- [x] 现有功能不受影响

### 4.2 性能验收
- [x] 内存使用符合预期（无滑动窗口开销）
- [x] 更新性能满足要求（覆盖操作高效）
- [x] 配置加载性能不退化

### 4.3 质量验收
- [x] 代码覆盖率达到90%以上
- [x] 通过python-code-reviewer审查（≥90分）
- [x] 所有测试通过
- [x] 配置验证和错误处理完善

## 5. 风险评估

### 5.1 技术风险

#### 5.1.1 配置兼容性风险
- **风险**：现有代码可能仍在引用废弃的配置项
- **缓解**：全面搜索代码库，确保所有引用都已更新
- **应急**：保留配置项但标记为deprecated，逐步迁移

#### 5.1.2 功能回归风险
- **风险**：配置更改可能导致depth_snapshot功能异常
- **缓解**：充分的集成测试和回归测试
- **应急**：快速回滚到原有配置

### 5.2 业务风险

#### 5.2.1 数据一致性风险
- **风险**：配置错误可能导致数据丢失或不一致
- **缓解**：配置验证和详细的错误日志
- **应急**：数据备份和恢复机制

## 6. 实施计划

### 6.1 开发阶段
1. **代码检查**：搜索所有使用`window_size`的代码位置
2. **配置更新**：修改development.yaml配置文件
3. **代码适配**：更新配置模型和相关代码
4. **测试开发**：编写单元测试和集成测试

### 6.2 验证阶段
1. **本地测试**：运行所有测试确保功能正常
2. **集成测试**：验证完整的data pipeline
3. **性能测试**：对比更新前后的性能指标
4. **代码审查**：通过python-code-reviewer审查

### 6.3 部署阶段
1. **文档更新**：更新相关技术文档
2. **配置验证**：确保生产环境配置正确
3. **监控部署**：监控系统运行状态
4. **回滚准备**：准备应急回滚方案

## 7. 成功指标

### 7.1 技术指标
- 配置文件大小减少10%以上
- 内存使用优化（移除滑动窗口开销）
- 代码质量评分≥90分
- 测试覆盖率≥90%

### 7.2 功能指标
- depth_snapshot功能100%正常
- 配置加载时间不增加
- 零配置相关错误
- 所有现有功能保持稳定

## 8. 附录

### 8.1 相关文件
- `config/development.yaml` - 需要更新的配置文件
- `src/utils/config.py` - 配置模型定义
- `src/agents/data_collector.py` - 数据收集器实现
- `tests/integration/test_depth_snapshot_overwrite.py` - 覆盖机制测试

### 8.2 参考资料
- Redis键命名规范：`REDIS_DEPTH_SNAPSHOT_KEY = "depth_snapshot_5000"`
- 现有的单键覆盖实现测试用例
- 系统配置最佳实践指南

---

**文档版本**: 1.0
**创建日期**: 2024-10-24
**作者**: Claude Code
**审核状态**: 待审核